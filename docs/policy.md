# Ray.Aop PECL拡張 実装方針

## 1. インターセプション機能の実装

- Zend Engineのフックを利用して、指定されたクラスとメソッドの呼び出しをインターセプトする機能を実装します。
- オリジナルのメソッド呼び出しをラップし、インターセプトハンドラーを呼び出すメカニズムを構築します。

## 2. InterceptedInterfaceの実装

- PHPユーザーランドで定義されるInterceptedInterfaceをC言語レベルで処理できるようにします。
- interceptメソッドの呼び出しを適切に処理し、ユーザー定義のインターセプトロジックを実行できるようにします。

## 3. method_intercept関数の実装

- クラス名、メソッド名、InterceptedInterfaceオブジェクトを受け取り、インターセプション情報を内部で管理する仕組みを作ります。
- 登録されたインターセプション情報を効率的に保存し、高速にアクセスできるデータ構造を設計します。

## 4. パフォーマンスの最適化

- インターセプション処理によるオーバーヘッドを最小限に抑えるため、効率的なコード生成やキャッシュ機構を検討します。
- 不要な場合にはインターセプション処理をスキップするような最適化を行います。

## 5. PHP8互換性

- 当初はPHP8のみをサポートし、PHP7との互換性は考慮しません。
- 将来的なPHP7サポートの可能性を考慮し、拡張性のある設計を心がけます。

## 6. メモリ管理

- インターセプション情報やオブジェクトの参照カウントを適切に管理し、メモリリークを防ぎます。

## 7. エラーハンドリング

- 無効な引数や実行時エラーに対して適切に対応し、PHPのエラーハンドリング機構と統合します。

## 8. 拡張性

- 将来的な機能拡張や変更に対応できるよう、モジュール化された設計を心がけます。

## 9. ユーザーランドでのマッチング

- マッチング処理はユーザーランドで行われることを前提とします。
- PECL拡張はインターセプターを直接呼び出すのではなく、インターセプトハンドラーを呼び出します。

## 10. インターセプトハンドラーの呼び出し

- インターセプションが発生した際、登録されたインターセプトハンドラーを呼び出します。
- インターセプトハンドラーがインターセプターの呼び出しを制御し、Ray.Aop以外のインターセプターとの連携を可能にします。

これらの方針に基づいて実装を進めることで、効率的で信頼性の高いRay.Aop PECL拡張を開発します。